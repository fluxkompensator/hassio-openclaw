#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Initialize OpenClaw configuration
# ==============================================================================

bashio::log.info "Initializing OpenClaw addon..."

# Create config directories
mkdir -p /data/openclaw
mkdir -p "$(bashio::config 'workspace_path')"

# Apply DNS/hosts overrides
MARKER="# OpenClaw DNS Override"
# Remove old OpenClaw entries first
sed -i "/${MARKER}/d" /etc/hosts 2>/dev/null || true

DNS_COUNT=$(bashio::config 'dns_overrides | length')
if [[ "${DNS_COUNT}" -gt 0 ]]; then
    bashio::log.info "Applying ${DNS_COUNT} DNS override(s)..."
    for ((i=0; i<DNS_COUNT; i++)); do
        ENTRY=$(bashio::config "dns_overrides[${i}]")
        if [[ -n "${ENTRY}" ]]; then
            echo "${ENTRY} ${MARKER}" >> /etc/hosts
            bashio::log.info "  Added: ${ENTRY}"
        fi
    done
fi

# Get configuration values
ANTHROPIC_API_KEY=$(bashio::config 'anthropic_api_key')
HA_ACCESS_TOKEN=$(bashio::config 'ha_access_token')
LOG_LEVEL=$(bashio::config 'log_level')
WORKSPACE_PATH=$(bashio::config 'workspace_path')
SIGNAL_ENABLED=$(bashio::config 'signal_enabled')
SIGNAL_PHONE=$(bashio::config 'signal_phone')
VOICE_TRANSCRIPTION=$(bashio::config 'voice_transcription')
TTS_VOICE=$(bashio::config 'tts_voice')

# Determine Home Assistant access method
if bashio::config.has_value 'ha_access_token'; then
    bashio::log.info "Using provided Home Assistant access token"
    HA_TOKEN="${HA_ACCESS_TOKEN}"
    HA_URL="http://supervisor/core"
else
    bashio::log.info "Using Supervisor API token"
    HA_TOKEN="${SUPERVISOR_TOKEN}"
    HA_URL="http://supervisor/core"
fi

# Create OpenClaw config directory
OPENCLAW_HOME="/data/openclaw"
mkdir -p "${OPENCLAW_HOME}"

# Generate or reuse gateway token (persists across restarts)
TOKEN_FILE="${OPENCLAW_HOME}/.gateway-token"
if [[ -f "${TOKEN_FILE}" ]]; then
    GATEWAY_TOKEN=$(cat "${TOKEN_FILE}")
else
    GATEWAY_TOKEN=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 32)
    echo "${GATEWAY_TOKEN}" > "${TOKEN_FILE}"
    chmod 600 "${TOKEN_FILE}"
fi

bashio::log.info "Gateway token configured"

# Log gateway token for user reference
bashio::log.info "Gateway token: ${GATEWAY_TOKEN}"

# Generate OpenClaw configuration in correct location
mkdir -p "${OPENCLAW_HOME}/.openclaw"

# Build Signal channel config if enabled
SIGNAL_CHANNEL_CONFIG=""
if bashio::var.true "${SIGNAL_ENABLED}"; then
    bashio::log.info "Signal channel enabled for phone: ${SIGNAL_PHONE}"
    mkdir -p "${OPENCLAW_HOME}/.signal-cli"
    SIGNAL_CHANNEL_CONFIG=$(cat << SIGNAL_EOF
  "channels": {
    "signal": {
      "enabled": true,
      "account": "${SIGNAL_PHONE}",
      "cliPath": "signal-cli",
      "dmPolicy": "open",
      "allowFrom": ["*"]
    }
  },
SIGNAL_EOF
)
fi

# Build audio transcription config if enabled
AUDIO_CONFIG=""
if [[ "${VOICE_TRANSCRIPTION}" == "sherpa-onnx" ]]; then
    bashio::log.info "Voice transcription enabled: sherpa-onnx"
    # Use wrapper script that handles AAC->WAV conversion
    if [[ -x "/usr/local/bin/transcribe-audio" ]]; then
        bashio::log.info "Using transcribe-audio wrapper (handles AAC->WAV conversion)"
        AUDIO_CONFIG=$(cat << AUDIO_EOF
  "tools": {
    "media": {
      "audio": {
        "enabled": true,
        "models": [
          {
            "type": "cli",
            "command": "/usr/local/bin/transcribe-audio",
            "args": ["{{MediaPath}}"]
          }
        ]
      }
    }
  },
AUDIO_EOF
)
    else
        bashio::log.warning "transcribe-audio wrapper not found"
    fi
fi

# Build TTS config for German voice (Edge TTS)
TTS_CONFIG=""
if bashio::config.has_value 'tts_voice' || [[ -n "${TTS_VOICE}" ]]; then
    TTS_VOICE_FINAL="${TTS_VOICE:-de-DE-ConradNeural}"
    bashio::log.info "TTS configured: Edge with voice ${TTS_VOICE_FINAL}"
    TTS_CONFIG=$(cat << TTS_EOF
  "messages": {
    "tts": {
      "auto": "always",
      "provider": "edge",
      "edge": {
        "voice": "${TTS_VOICE_FINAL}"
      }
    }
  },
TTS_EOF
)
fi

cat > "${OPENCLAW_HOME}/.openclaw/openclaw.json" << EOF
{
  "env": {
    "ANTHROPIC_API_KEY": "${ANTHROPIC_API_KEY}"
  },
  "agents": {
    "defaults": {
      "workspace": "${WORKSPACE_PATH}",
      "model": {
        "primary": "anthropic/claude-opus-4-5"
      },
      "contextPruning": {
        "mode": "cache-ttl",
        "ttl": "5m",
        "keepLastAssistants": 1
      }
    }
  },
${AUDIO_CONFIG}
${TTS_CONFIG}
${SIGNAL_CHANNEL_CONFIG}
  "gateway": {
    "port": 18789,
    "bind": "lan",
    "mode": "local",
    "trustedProxies": ["172.30.32.0/23", "127.0.0.1", "::1"],
    "auth": {
      "mode": "token",
      "token": "${GATEWAY_TOKEN}"
    },
    "controlUi": {
      "enabled": true,
      "allowInsecureAuth": true
    }
  }
}
EOF

# Export environment variables for the main service
{
    echo "HA_TOKEN=${HA_TOKEN}"
    echo "HA_URL=${HA_URL}"
    echo "OPENCLAW_STATE_DIR=${OPENCLAW_HOME}/.openclaw"
    echo "OPENCLAW_WORKSPACE_DIR=${WORKSPACE_PATH}"
    echo "HOME=${OPENCLAW_HOME}"
    echo "OPENCLAW_GATEWAY_TOKEN=${GATEWAY_TOKEN}"
    echo "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}"
    # Signal settings via env vars
    echo "SIGNAL_CLI_CONFIG_DIR=${OPENCLAW_HOME}/.signal-cli"
    echo "SIGNAL_PHONE=${SIGNAL_PHONE}"
    echo "SIGNAL_TRANSCRIPTION=${VOICE_TRANSCRIPTION}"
} > /var/run/s6/container_environment/openclaw-env

# Install Home Assistant skills
SKILL_DIR="${OPENCLAW_HOME}/.openclaw/skills"
mkdir -p "${SKILL_DIR}"

# Install bundled HA skill (optimized for addon environment)
if [[ ! -d "${SKILL_DIR}/homeassistant-addon" ]]; then
    cp -r /opt/ha-skill "${SKILL_DIR}/homeassistant-addon"
    bashio::log.info "Installed homeassistant-addon skill"
fi

# ClawHub skills removed - unknown token cost, redundant with bundled skill

# Create workspace bootstrap files (only if missing - preserves user customizations)
create_if_missing() {
    local file="$1"
    local content="$2"
    if [[ ! -f "${WORKSPACE_PATH}/${file}" ]]; then
        echo "${content}" > "${WORKSPACE_PATH}/${file}"
        bashio::log.info "Created ${file}"
    else
        bashio::log.debug "${file} already exists, skipping"
    fi
}

# AGENTS.md - Operating instructions and memory
create_if_missing "AGENTS.md" "# Home Assistant Voice Assistant

You are a Home Assistant voice assistant running via OpenClaw. Your primary purpose is controlling smart home devices.

## CRITICAL: Token Efficiency

**API calls cost tokens. Follow these rules to avoid burning \$\$\$:**

1. **NEVER call /api/states** - Returns ALL entities, wastes 100K+ tokens
2. **Don't query before acting** - For \"turn on bathroom light\" â†’ just call the service
3. **Use Template API for searches** - Returns only entity IDs (tiny response)
4. **Single entity queries only** - /api/states/light.specific_one is OK

## Environment

- \\\$HA_URL = http://supervisor/core
- \\\$HA_TOKEN = authentication token

## Patterns

**Control device (no query needed):**
curl -sX POST -H \"Authorization: Bearer \\\$HA_TOKEN\" -H \"Content-Type: application/json\" -d '{\"entity_id\": \"light.bathroom\"}' \"\\\$HA_URL/api/services/light/turn_on\"

**Find by area (token-efficient):**
curl -sX POST -H \"Authorization: Bearer \\\$HA_TOKEN\" -H \"Content-Type: application/json\" -d '{\"template\": \"{{ area_entities(\\\"bathroom\\\") }}\"}' \"\\\$HA_URL/api/template\"

## Guidelines

1. **Be concise** - Voice responses should be short and natural
2. **Search by area** - Users say \"bathroom light\" not entity IDs
3. **Confirm actions** - \"Turning on the bathroom light\"
4. **Handle errors gracefully** - \"I couldn't find that device\""

# SOUL.md - Persona and behavioral boundaries
create_if_missing "SOUL.md" "# Personality

You are a helpful, efficient home assistant. You speak naturally and concisely, like a smart speaker assistant.

## Communication Style
- Brief, conversational responses
- German language (match user's language)
- No unnecessary explanations
- Confirm actions taken
- Ask for clarification when ambiguous

## Boundaries
- Only control devices the user mentions
- Don't make assumptions about device states
- Don't execute potentially dangerous actions without confirmation"

# TOOLS.md - Tool usage notes and patterns
create_if_missing "TOOLS.md" "# Tool Usage Guidelines

## Home Assistant Control

Use the \`homeassistant-addon\` skill for full API documentation. Quick reference:

### Service Domains
- light: turn_on, turn_off, toggle
- switch: turn_on, turn_off, toggle
- climate: set_temperature, set_hvac_mode
- cover: open_cover, close_cover, set_cover_position
- automation: trigger, turn_on, turn_off
- script: turn_on
- scene: turn_on
- media_player: media_play_pause, volume_set

### Area-Based Queries (Recommended)
Use Template API to find entities by room:
\\\`\\\`\\\`
{{ area_entities(\"bathroom\") | select(\"match\", \"light.*\") | list }}
\\\`\\\`\\\`

### Entity ID Patterns
Common domains: light., switch., climate., cover., script., automation., sensor., binary_sensor."

# IDENTITY.md - Agent name and character
create_if_missing "IDENTITY.md" "name: Assistant
emoji: ðŸ 
character: Home automation assistant"

# USER.md - User profile and preferences
create_if_missing "USER.md" "# User Profile

Language: German
Location: Home
Interaction style: Voice commands via Signal/HA Assist"

bashio::log.info "Workspace bootstrap files configured"

# Configure authentication (OAuth credentials or API key)
AGENT_DIR="${OPENCLAW_HOME}/.openclaw/agents/main/agent"
mkdir -p "${AGENT_DIR}"

CLAUDE_OAUTH=$(bashio::config 'claude_oauth_credentials')

if [[ -n "${CLAUDE_OAUTH}" ]]; then
    # OAuth mode - parse Claude credentials and create auth-profiles.json
    bashio::log.info "Using Claude OAuth credentials from config"

    # Parse OAuth fields from Claude credentials JSON
    ACCESS_TOKEN=$(echo "${CLAUDE_OAUTH}" | jq -r '.accessToken // empty')
    REFRESH_TOKEN=$(echo "${CLAUDE_OAUTH}" | jq -r '.refreshToken // empty')
    EXPIRES_AT=$(echo "${CLAUDE_OAUTH}" | jq -r '.expiresAt // empty')

    if [[ -n "${ACCESS_TOKEN}" ]]; then
        # Create OAuth auth-profiles.json
        cat > "${AGENT_DIR}/auth-profiles.json" << EOF
{
  "version": 1,
  "profiles": {
    "anthropic:oauth": {
      "type": "oauth",
      "provider": "anthropic",
      "accessToken": "${ACCESS_TOKEN}",
      "refreshToken": "${REFRESH_TOKEN}",
      "expiresAt": ${EXPIRES_AT:-0}
    }
  }
}
EOF
        chmod 600 "${AGENT_DIR}/auth-profiles.json"
        bashio::log.info "OAuth credentials configured (expires: ${EXPIRES_AT})"
    else
        bashio::log.error "Invalid OAuth credentials JSON - missing accessToken"
    fi

elif bashio::config.has_value 'anthropic_api_key'; then
    # API key mode (existing behavior)
    bashio::log.info "Using provided Anthropic API key"
    cat > "${AGENT_DIR}/auth-profiles.json" << EOF
{
  "version": 1,
  "profiles": {
    "anthropic:manual": {
      "type": "token",
      "provider": "anthropic",
      "token": "${ANTHROPIC_API_KEY}"
    }
  }
}
EOF
else
    bashio::log.error "No authentication configured! Set either:"
    bashio::log.error "  - anthropic_api_key (API key from console.anthropic.com)"
    bashio::log.error "  - claude_oauth_credentials (JSON from claude setup-token)"
fi

bashio::log.info "Authentication configured"

# Run openclaw doctor --fix if Signal is enabled to apply channel changes
if bashio::var.true "${SIGNAL_ENABLED}"; then
    bashio::log.info "Running openclaw doctor --fix to enable Signal channel..."
    cd "${WORKSPACE_PATH}" || exit 1
    HOME="${OPENCLAW_HOME}" openclaw doctor --fix || bashio::log.warning "openclaw doctor --fix returned non-zero"
fi

# Run openclaw setup to initialize workspace properly
bashio::log.info "Running openclaw setup to initialize workspace..."
cd "${WORKSPACE_PATH}" || exit 1
HOME="${OPENCLAW_HOME}" openclaw setup --workspace "${WORKSPACE_PATH}" 2>/dev/null || bashio::log.debug "openclaw setup completed (or already initialized)"

bashio::log.info "OpenClaw initialization complete"
