#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Start signal-cli daemon for OpenClaw Signal channel
# ==============================================================================

# Source environment variables
if [[ -f /var/run/s6/container_environment/openclaw-env ]]; then
    # shellcheck disable=SC1091
    source /var/run/s6/container_environment/openclaw-env
fi

# Check if Signal is enabled
SIGNAL_ENABLED=$(bashio::config 'signal_enabled')
if ! bashio::var.true "${SIGNAL_ENABLED}"; then
    bashio::log.info "Signal channel disabled, not starting signal-cli daemon"
    exec sleep infinity
fi

# Get phone number
SIGNAL_PHONE=$(bashio::config 'signal_phone')
if [[ -z "${SIGNAL_PHONE}" ]]; then
    bashio::log.error "Signal phone number not configured"
    exec sleep infinity
fi

# Set signal-cli config directory
export SIGNAL_CLI_CONFIG_DIR="${SIGNAL_CLI_CONFIG_DIR:-/data/openclaw/.signal-cli}"

bashio::log.info "Starting signal-cli daemon for ${SIGNAL_PHONE}..."

# Run signal-cli in daemon mode with JSON-RPC over stdout
exec signal-cli -a "${SIGNAL_PHONE}" daemon --socket /tmp/signal-cli.sock
