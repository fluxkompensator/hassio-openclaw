#!/bin/bash
# Wrapper script for sherpa-onnx that converts any audio format to WAV first
# Usage: transcribe-audio <input-audio-file>

# Timing instrumentation for performance debugging
START_TIME=$(date +%s.%N)
log_timing() {
    echo "[transcribe $(date -Is)] $1" >&2
}

INPUT_FILE="$1"
if [[ -z "$INPUT_FILE" || ! -f "$INPUT_FILE" ]]; then
    echo "Error: Input file not found: $INPUT_FILE" >&2
    exit 1
fi

FILE_SIZE=$(stat -c%s "$INPUT_FILE" 2>/dev/null || stat -f%z "$INPUT_FILE" 2>/dev/null || echo "unknown")
log_timing "Starting: $INPUT_FILE ($FILE_SIZE bytes)"

# Find sherpa-onnx binary (architecture-independent)
SHERPA_BIN=""
for dir in /opt/sherpa-onnx-*/bin; do
    if [[ -x "$dir/sherpa-onnx-offline" ]]; then
        SHERPA_BIN="$dir/sherpa-onnx-offline"
        break
    fi
done

if [[ ! -x "$SHERPA_BIN" ]]; then
    echo "Error: sherpa-onnx-offline not found" >&2
    exit 1
fi

# Whisper model directory (small model for best accuracy)
WHISPER_DIR="/opt/sherpa-onnx-whisper-small"
if [[ ! -d "$WHISPER_DIR" ]]; then
    echo "Error: Whisper model not found at $WHISPER_DIR" >&2
    exit 1
fi

# Create temp WAV file
TEMP_WAV=$(mktemp /tmp/transcribe-XXXXXX.wav)
trap "rm -f $TEMP_WAV" EXIT

# Convert input to 16kHz mono WAV (required by sherpa-onnx)
if ! ffmpeg -y -i "$INPUT_FILE" -ar 16000 -ac 1 -f wav "$TEMP_WAV" 2>/dev/null; then
    echo "Error: ffmpeg conversion failed" >&2
    exit 1
fi

# Run sherpa-onnx
OUTPUT=$("$SHERPA_BIN" \
    --whisper-encoder="$WHISPER_DIR/small-encoder.onnx" \
    --whisper-decoder="$WHISPER_DIR/small-decoder.onnx" \
    --tokens="$WHISPER_DIR/small-tokens.txt" \
    "$TEMP_WAV" 2>&1)

# Extract text from JSON line (sherpa outputs: {"lang": "...", "text": "...", ...})
# Use grep to find the JSON line, then extract the text field
TEXT=$(echo "$OUTPUT" | grep '"text"' | sed 's/.*"text": *"//;s/".*//')

END_TIME=$(date +%s.%N)
DURATION=$(echo "$END_TIME - $START_TIME" | bc 2>/dev/null || echo "N/A")
log_timing "Completed in ${DURATION}s"

if [[ -n "$TEXT" ]]; then
    echo "$TEXT"
else
    # Fallback: output everything after "Done!" if no JSON found
    echo "$OUTPUT" | sed -n '/^Done!/,$ p' | tail -n +2
fi
