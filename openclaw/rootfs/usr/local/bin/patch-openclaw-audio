#!/bin/bash
# Patch OpenClaw to filter out raw audio files from model context
# This prevents Claude from using native audio support after local transcription
# See: https://github.com/openclaw/openclaw/issues/4197

APPLY_JS="/usr/lib/node_modules/openclaw/dist/media-understanding/apply.js"

if [[ ! -f "$APPLY_JS" ]]; then
    echo "Error: apply.js not found at $APPLY_JS" >&2
    exit 1
fi

# Check if already patched with v2
if grep -q "PATCH_V2_AUDIO_FILTER" "$APPLY_JS"; then
    echo "OpenClaw audio patch v2 already applied"
    exit 0
fi

# Create backup
cp "$APPLY_JS" "$APPLY_JS.bak"

# Create a Node.js script to properly patch the file
node << 'NODEJS_PATCH'
const fs = require('fs');
const path = '/usr/lib/node_modules/openclaw/dist/media-understanding/apply.js';

let code = fs.readFileSync(path, 'utf8');

// Add the audio filter helper at the top of the file
const audioFilterCode = `
// PATCH_V2_AUDIO_FILTER: Skip audio files from model context
const _audioExtsToFilter = new Set(['.ogg', '.opus', '.mp3', '.wav', '.aac', '.flac', '.m4a', '.oga', '.webm', '.amr', '.3gp']);
function _shouldFilterAudioFile(filePath) {
    if (!filePath) return false;
    const ext = '.' + String(filePath).toLowerCase().split('.').pop();
    return _audioExtsToFilter.has(ext);
}
`;

// Insert at the beginning after imports
const importMatch = code.match(/^(import .+\n)+/m);
if (importMatch) {
    const insertPos = importMatch.index + importMatch[0].length;
    code = code.slice(0, insertPos) + audioFilterCode + code.slice(insertPos);
}

// Find the attachment processing loop and add early exit for audio files
// Look for: const nameHint = bufferResult?.fileName ?? attachment.path ?? attachment.url;
// Add after it: if (_shouldFilterAudioFile(nameHint)) { continue; }

code = code.replace(
    /(const nameHint = bufferResult\?\.fileName \?\? attachment\.path \?\? attachment\.url;)/g,
    `$1
        // PATCH: Skip audio files unconditionally
        if (_shouldFilterAudioFile(nameHint)) {
            logVerbose?.(\`media: file attachment skipped (audio filter) path=\${nameHint}\`);
            continue;
        }`
);

fs.writeFileSync(path, code);
console.log('OpenClaw audio patch v2 applied successfully');
NODEJS_PATCH

echo "Patch complete"
