# OpenClaw Voice Satellite for ESPHome
#
# This configuration creates a voice assistant satellite that integrates
# with Home Assistant Assist and OpenClaw.
#
# Hardware Options:
#   1. ESP32-S3-BOX-3 (~$45) - All-in-one, recommended
#   2. M5Stack ATOM Echo (~$13) - Budget option
#   3. Custom build (~$25) - Best audio quality
#
# For custom builds, adjust the pin numbers below to match your wiring.

esphome:
  name: voice-satellite
  friendly_name: Voice Satellite
  comment: OpenClaw Voice Assistant Satellite

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Voice-Satellite-Fallback"
    password: !secret ap_password

captive_portal:

# I2S Audio Configuration
# For custom builds with INMP441 microphone and MAX98357 amplifier
i2s_audio:
  - id: i2s_in
    i2s_lrclk_pin: GPIO3   # WS (Word Select)
    i2s_bclk_pin: GPIO2    # SCK (Bit Clock)
  - id: i2s_out
    i2s_lrclk_pin: GPIO6   # WS
    i2s_bclk_pin: GPIO5    # BCLK

# Microphone (INMP441)
microphone:
  - platform: i2s_audio
    id: mic
    i2s_audio_id: i2s_in
    i2s_din_pin: GPIO4     # SD (Serial Data)
    adc_type: external
    pdm: false
    bits_per_sample: 32bit
    channel: left

# Speaker (MAX98357)
speaker:
  - platform: i2s_audio
    id: speaker
    i2s_audio_id: i2s_out
    i2s_dout_pin: GPIO7    # DIN
    dac_type: external
    mode: mono

# Voice Assistant Configuration
voice_assistant:
  microphone: mic
  speaker: speaker
  use_wake_word: true
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0

  on_wake_word_detected:
    - light.turn_on:
        id: led
        effect: pulse
        red: 0%
        green: 100%
        blue: 0%

  on_listening:
    - light.turn_on:
        id: led
        effect: none
        red: 0%
        green: 0%
        blue: 100%

  on_stt_vad_end:
    - light.turn_on:
        id: led
        effect: pulse
        red: 100%
        green: 100%
        blue: 0%

  on_tts_start:
    - light.turn_on:
        id: led
        effect: none
        red: 100%
        green: 0%
        blue: 100%

  on_tts_end:
    - light.turn_off: led

  on_error:
    - light.turn_on:
        id: led
        effect: none
        red: 100%
        green: 0%
        blue: 0%
    - delay: 3s
    - light.turn_off: led

  on_client_disconnected:
    - light.turn_on:
        id: led
        effect: slow_pulse
        red: 100%
        green: 50%
        blue: 0%

  on_client_connected:
    - light.turn_off: led

# Status LED (WS2812/SK6812 - adjust for your hardware)
light:
  - platform: esp32_rmt_led_strip
    id: led
    pin: GPIO48
    num_leds: 1
    rgb_order: GRB
    chipset: SK6812
    rmt_channel: 0
    name: "Status LED"
    effects:
      - pulse:
          name: pulse
          transition_length: 250ms
          update_interval: 250ms
      - pulse:
          name: slow_pulse
          transition_length: 1s
          update_interval: 1s

# Physical button to trigger voice assistant
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode:
        input: true
        pullup: true
      inverted: true
    name: "Voice Button"
    on_click:
      - voice_assistant.start:

# Expose mute switch
switch:
  - platform: template
    name: "Mute"
    id: mute_switch
    optimistic: true
    on_turn_on:
      - voice_assistant.stop:
    on_turn_off:
      - voice_assistant.start:

# Device sensors
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    update_interval: 60s

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"
